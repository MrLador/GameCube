<!DOCTYPE html>
<html>
<head>
    <title>Dust Racer</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #2c3e50; 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        canvas {
            background: #27ae60;
            border: 2px solid #34495e;
        }
        #hud {
            position: fixed; 
            top: 10px; 
            left: 10px;
            color: white; 
            font-family: Arial; 
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div id="hud">Laps: <span id="laps">0</span>/2</div>
    <canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const SCALE = 0.8;
canvas.width = 1000 * SCALE;
canvas.height = 800 * SCALE;

const TRACK = [
    {x: 500, y: 700, w: 300},    // Стартовая прямая
    {x: 500, y: 500, w: 300, r: 30}, // Правый поворот
    {x: 700, y: 300, w: 300, r: 90}, // Шпилька
    {x: 500, y: 100, w: 300},    // Прямая
    {x: 300, y: 300, w: 300, r: -90}, // Левый поворот
    {x: 500, y: 500, w: 300, r: -30}  // Обратный поворот
];

class Car {
    constructor(color) {
        this.reset();
        this.color = color;
    }

    reset() {
        this.x = 500 * SCALE;
        this.y = 700 * SCALE;
        this.speed = 0;
        this.angle = 0;
        this.laps = 0;
        this.checkpoint = 0;
    }

    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle * Math.PI / 180);
        
        // Кузов
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.roundRect(-20*SCALE, -10*SCALE, 40*SCALE, 20*SCALE, 5*SCALE);
        ctx.fill();
        
        // Кабина
        ctx.fillStyle = '#ecf0f1';
        ctx.beginPath();
        ctx.roundRect(-15*SCALE, -8*SCALE, 30*SCALE, 10*SCALE, 3*SCALE);
        ctx.fill();
        
        // Колёса
        ctx.fillStyle = '#2c3e50';
        [[-1, -1], [1, -1], [-1, 1], [1, 1]].forEach(([x, y]) => {
            ctx.beginPath();
            ctx.arc(x * 25*SCALE, y * 15*SCALE, 5*SCALE, 0, Math.PI*2);
            ctx.fill();
        });
        
        ctx.restore();
    }

    update() {
        this.x += Math.cos(this.angle * Math.PI / 180) * this.speed * SCALE;
        this.y += Math.sin(this.angle * Math.PI / 180) * this.speed * SCALE;
        this.speed *= 0.96;
    }
}

const player = new Car('#e74c3c');
const bots = Array.from({length: 5}, (_, i) => 
    new Car(['#3498db', '#9b59b6', '#2ecc71', '#f1c40f', '#95a5a6'][i]));

function init() {
    bots.forEach((bot, i) => {
        bot.reset();
        bot.x += (i - 2) * 40 * SCALE;
        bot.speed = 3 + Math.random() * 2;
    });
}

function drawTrack() {
    ctx.fillStyle = '#7f8c8d';
    TRACK.forEach(segment => {
        ctx.beginPath();
        ctx.roundRect(
            (segment.x - segment.w/2) * SCALE, 
            segment.y * SCALE, 
            segment.w * SCALE, 
            200 * SCALE, 
            20 * SCALE
        );
        ctx.fill();
    });
}

function aiMove(bot) {
    const target = TRACK[bot.checkpoint % TRACK.length];
    const dx = target.x * SCALE - bot.x;
    const dy = target.y * SCALE - bot.y;
    bot.angle = Math.atan2(dy, dx) * 180 / Math.PI;
    
    if(Math.hypot(dx, dy) < 50 * SCALE) {
        bot.checkpoint = (bot.checkpoint + 1) % TRACK.length;
    }
    bot.speed = Math.min(6, bot.speed + 0.1);
}

function checkCollision(a, b) {
    return Math.hypot(a.x - b.x, a.y - b.y) < 30 * SCALE;
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Отрисовка трека
    drawTrack();
    
    // Обновление ботов
    bots.forEach(bot => {
        aiMove(bot);
        bot.update();
        bot.draw();
    });
    
    // Обновление игрока
    player.update();
    player.draw();
    
    // Проверка кругов
    if(player.checkpoint >= TRACK.length) {
        player.laps++;
        document.getElementById('laps').textContent = player.laps;
        player.checkpoint = 0;
        if(player.laps >= 2) {
            alert('Победа!');
            init();
            player.reset();
            return;
        }
    }
    
    // Проверка чекпоинтов
    TRACK.forEach((seg, i) => {
        if(Math.hypot(
            player.x - seg.x * SCALE, 
            player.y - seg.y * SCALE
        ) < 50 * SCALE) {
            if(i === player.checkpoint) player.checkpoint++;
        }
    });
    
    // Коллизии
    bots.forEach(bot => {
        if(checkCollision(player, bot)) {
            player.speed *= 0.7;
            bot.speed *= 0.7;
        }
    });
    
    requestAnimationFrame(gameLoop);
}

document.addEventListener('keydown', e => {
    if(e.key === 'ArrowLeft') player.angle -= 5;
    if(e.key === 'ArrowRight') player.angle += 5;
    player.speed = Math.min(8, player.speed + 0.3);
});

// Адаптивность
window.addEventListener('resize', () => {
    canvas.width = window.innerWidth * SCALE;
    canvas.height = window.innerHeight * SCALE;
});

init();
gameLoop();
</script>
</body>
</html>
