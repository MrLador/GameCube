<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Игры: Пинпонг, Сапёр и Гонки с палитрами</title>
  <style>
    :root {
      --bg-color: #000000;
      --text-color: #ffffff;
      --btn-bg: #0a84ff;
      --btn-bg-hover: #0066cc;
      --game-bg: #222222;
      --paddle-color: #ffffff;
      --ball-color: #ffffff;
      --net-color: #ffffff;
      --rating-bg: #111111;
      --rating-border: #ffffff;
      --ms-cell-bg: #555555;
      --ms-cell-revealed-bg: #bbbbbb;
      --ms-cell-flag-color: #f00;
      --ms-cell-text-color: black;
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --transition-speed: 0.3s;
    }
    /* Сброс и базовые стили */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: var(--bg-color);
      color: var(--text-color);
      font-family: var(--font-family);
      user-select: none;
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background var(--transition-speed), color var(--transition-speed);
    }
    /* Центрирование меню */
    #menu {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: var(--game-bg);
      z-index: 1000;
      padding: 20px;
      transition: background var(--transition-speed);
    }
    #menu h1 {
      font-size: 3.5rem;
      margin-bottom: 40px;
      font-weight: 700;
      letter-spacing: 2px;
      text-shadow: 0 0 8px rgba(10, 132, 255, 0.7);
    }
    #menu button {
      font-size: 1.5rem;
      padding: 15px 50px;
      margin: 15px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: var(--btn-bg);
      color: var(--text-color);
      box-shadow: 0 4px 15px rgba(10, 132, 255, 0.5);
      transition: background var(--transition-speed), box-shadow var(--transition-speed);
      user-select: none;
      font-weight: 600;
      letter-spacing: 1px;
      min-width: 220px;
      text-align: center;
    }
    #menu button:hover, #menu button:focus {
      background: var(--btn-bg-hover);
      box-shadow: 0 6px 20px rgba(0, 102, 204, 0.7);
      outline: none;
    }
    #settings {
      margin-top: 40px;
      text-align: center;
      color: var(--text-color);
      font-size: 1.1rem;
      user-select: none;
    }
    #settings label {
      margin-right: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    #settings select {
      font-size: 1.1rem;
      padding: 8px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: var(--btn-bg);
      color: var(--text-color);
      box-shadow: 0 3px 10px rgba(10, 132, 255, 0.5);
      transition: background var(--transition-speed), box-shadow var(--transition-speed);
      min-width: 180px;
      font-weight: 600;
    }
    #settings select:hover, #settings select:focus {
      background: var(--btn-bg-hover);
      box-shadow: 0 5px 15px rgba(0, 102, 204, 0.7);
      outline: none;
    }

    /* Общие стили для игр */
    .game-wrapper {
      display: none;
      flex-grow: 1;
      background: var(--game-bg);
      position: relative;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
      padding: 20px;
      transition: background var(--transition-speed);
    }

    /* Пинпонг */
    #pong-container {
      display: flex;
      flex-grow: 1;
      flex-direction: row;
      overflow: hidden;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }
    #game-container {
      position: relative;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--game-bg);
      border-radius: 20px;
      box-shadow: 0 0 30px rgba(10, 132, 255, 0.6);
      padding: 20px;
      user-select: none;
    }
    canvas {
      background: var(--game-bg);
      border: 3px solid var(--rating-border);
      border-radius: 16px;
      display: block;
      touch-action: none;
      box-shadow: 0 0 20px rgba(10, 132, 255, 0.8);
      transition: border-color var(--transition-speed);
    }
    #score {
      font-size: 2rem;
      margin: 15px 0;
      letter-spacing: 12px;
      user-select: none;
      color: var(--text-color);
      font-weight: 700;
      text-shadow: 0 0 6px rgba(10, 132, 255, 0.8);
    }
    #pause-btn, #mode-btn, #pong-back-btn {
      position: absolute;
      background: #222a44;
      border: none;
      color: var(--text-color);
      font-size: 1rem;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 10px;
      user-select: none;
      z-index: 10;
      transition: background var(--transition-speed), box-shadow var(--transition-speed);
      box-shadow: 0 0 8px rgba(10, 132, 255, 0.6);
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    #pause-btn:hover, #mode-btn:hover, #pong-back-btn:hover,
    #pause-btn:focus, #mode-btn:focus, #pong-back-btn:focus {
      background: #1a2240;
      box-shadow: 0 0 15px rgba(0, 102, 204, 0.9);
      outline: none;
    }
    #pause-btn {
      top: 12px;
      left: 12px;
    }
    #mode-btn {
      top: 12px;
      left: 120px;
    }
    #pong-back-btn {
      top: 12px;
      right: 12px;
    }
    #nickname-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 20;
      border-radius: 20px;
      padding: 20px;
      box-sizing: border-box;
      user-select: none;
    }
    #nickname-overlay input {
      font-size: 1.3rem;
      padding: 14px 20px;
      border-radius: 12px;
      border: none;
      width: 280px;
      margin-bottom: 20px;
      text-align: center;
      color: var(--text-color);
      background: #222a44;
      box-shadow: inset 0 0 8px rgba(10, 132, 255, 0.7);
      transition: background var(--transition-speed), box-shadow var(--transition-speed);
      font-weight: 600;
    }
    #nickname-overlay input::placeholder {
      color: #a0a0a0;
    }
    #nickname-overlay input:focus {
      background: #1a2240;
      box-shadow: inset 0 0 12px rgba(0, 102, 204, 0.9);
      outline: none;
    }
    #nickname-overlay button {
      font-size: 1.2rem;
      padding: 14px 40px;
      border-radius: 12px;
      border: none;
      background: var(--btn-bg);
      color: var(--text-color);
      cursor: pointer;
      user-select: none;
      font-weight: 700;
      letter-spacing: 1px;
      box-shadow: 0 0 15px rgba(10, 132, 255, 0.8);
      transition: background var(--transition-speed), box-shadow var(--transition-speed);
    }
    #nickname-overlay button:hover, #nickname-overlay button:focus {
      background: var(--btn-bg-hover);
      box-shadow: 0 0 25px rgba(0, 102, 204, 1);
      outline: none;
    }
    #rating {
      width: 320px;
      background: var(--rating-bg);
      border-left: 3px solid var(--rating-border);
      padding: 25px 20px;
      box-sizing: border-box;
      overflow-y: auto;
      color: var(--text-color);
      font-weight: 600;
      font-size: 1rem;
      border-radius: 0 20px 20px 0;
      box-shadow: inset 0 0 15px rgba(10, 132, 255, 0.5);
      user-select: none;
    }
    #rating h2 {
      margin-top: 0;
      text-align: center;
      font-weight: 700;
      border-bottom: 1px solid #555;
      padding-bottom: 12px;
      letter-spacing: 1px;
      font-size: 1.3rem;
      text-shadow: 0 0 6px rgba(10, 132, 255, 0.7);
    }
    #rating table {
      width: 100%;
      border-collapse: collapse;
      color: var(--text-color);
    }
    #rating th, #rating td {
      padding: 10px 8px;
      border-bottom: 1px solid #444;
      text-align: center;
      transition: background var(--transition-speed);
    }
    #rating th {
      background: #333;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    #rating tbody tr:hover {
      background: #222;
    }
    #rating::-webkit-scrollbar {
      width: 8px;
    }
    #rating::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 4px;
    }

    /* Сапёр */
    #minesweeper-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 30px 20px;
      flex-grow: 1;
      overflow-y: auto;
      background: var(--game-bg);
      width: 100%;
      box-sizing: border-box;
      color: var(--text-color);
      max-width: 480px;
      margin: 0 auto;
      border-radius: 20px;
      box-shadow: 0 0 30px rgba(10, 132, 255, 0.6);
      user-select: none;
      transition: background var(--transition-speed);
    }
    #ms-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    #ms-status {
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 0 0 6px rgba(10, 132, 255, 0.7);
    }
    #ms-header button {
      background: #222a44;
      border: none;
      color: var(--text-color);
      font-size: 1rem;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 12px;
      user-select: none;
      transition: background var(--transition-speed), box-shadow var(--transition-speed);
      box-shadow: 0 0 10px rgba(10, 132, 255, 0.6);
      font-weight: 600;
      letter-spacing: 0.5px;
      min-width: 110px;
    }
    #ms-header button:hover, #ms-header button:focus {
      background: #1a2240;
      box-shadow: 0 0 20px rgba(0, 102, 204, 0.9);
      outline: none;
    }
    #ms-board {
      display: grid;
      grid-template-columns: repeat(9, 44px);
      grid-template-rows: repeat(9, 44px);
      gap: 4px;
      background: #333;
      border: 3px solid var(--rating-border);
      border-radius: 16px;
      user-select: none;
      box-shadow: inset 0 0 20px rgba(10, 132, 255, 0.7);
      transition: border-color var(--transition-speed);
    }
    .ms-cell {
      width: 44px;
      height: 44px;
      background: var(--ms-cell-bg);
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 700;
      font-size: 22px;
      cursor: pointer;
      color: var(--text-color);
      user-select: none;
      position: relative;
      transition: background var(--transition-speed), color var(--transition-speed);
      box-shadow: 0 0 6px rgba(10, 132, 255, 0.4);
    }
    .ms-cell.revealed {
      background: var(--ms-cell-revealed-bg);
      color: var(--ms-cell-text-color);
      cursor: default;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
    }
    .ms-cell.flagged::after {
      content: "🚩";
      position: absolute;
      font-size: 22px;
      top: 2px;
      right: 4px;
      color: var(--ms-cell-flag-color);
      text-shadow: 0 0 4px rgba(255,0,0,0.8);
    }
    .ms-cell.mine {
      background: #f44336;
      color: black;
      box-shadow: inset 0 0 12px #b71c1c;
    }

    /* Гонки */
    #racing-container {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
      flex-grow: 1;
      background: var(--game-bg);
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      border-radius: 20px;
      box-shadow: 0 0 30px rgba(10, 132, 255, 0.6);
      user-select: none;
      transition: background var(--transition-speed);
      position: relative;
    }
    #racing-canvas {
      background: #111;
      border-radius: 20px;
      box-shadow: inset 0 0 20px rgba(10,132,255,0.7);
      display: block;
      margin-bottom: 20px;
      border: 3px solid var(--rating-border);
      max-width: 100%;
    }
    #racing-info {
      color: var(--text-color);
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 0 0 6px rgba(10, 132, 255, 0.7);
      margin-bottom: 20px;
      user-select: none;
    }
    #racing-back-btn {
      background: #222a44;
      border: none;
      color: var(--text-color);
      font-size: 1rem;
      padding: 10px 24px;
      cursor: pointer;
      border-radius: 12px;
      user-select: none;
      transition: background var(--transition-speed), box-shadow var(--transition-speed);
      box-shadow: 0 0 10px rgba(10, 132, 255, 0.6);
      font-weight: 600;
      letter-spacing: 0.5px;
      align-self: center;
      min-width: 120px;
    }
    #racing-back-btn:hover, #racing-back-btn:focus {
      background: #1a2240;
      box-shadow: 0 0 20px rgba(0, 102, 204, 0.9);
      outline: none;
    }
  </style>
</head>
<body>
  <!-- Меню выбора игры -->
  <div id="menu">
    <h1>Выберите игру</h1>
    <button id="btn-pong" type="button">Пинпонг</button>
    <button id="btn-minesweeper" type="button">Сапёр</button>
    <button id="btn-racing" type="button">Гонки</button>

    <div id="settings" aria-label="Настройки цветовой палитры">
      <label for="palette-select">Цветовая палитра:</label>
      <select id="palette-select" title="Выберите цветовую палитру" aria-describedby="palette-desc">
        <option value="random">Случайный (по умолчанию)</option>
        <option value="default">Классическая</option>
        <option value="sunset">Закат</option>
        <option value="ocean">Океан</option>
        <option value="forest">Лес</option>
        <option value="neon">Неон</option>
      </select>
      <div id="palette-desc" style="font-size:0.9rem; margin-top:6px; color:#aaa;">
        Выберите цветовую палитру для интерфейса и игр.
      </div>
    </div>
  </div>

  <!-- Пинпонг -->
  <div id="pong-container" class="game-wrapper" role="main" aria-label="Игра Пинпонг">
    <div id="game-container">
      <button id="pause-btn" title="Пауза" type="button" aria-pressed="false">Пауза</button>
      <button id="mode-btn" title="Переключить режим" type="button">Режим: ПК</button>
      <button id="pong-back-btn" title="Вернуться в меню" type="button">Меню</button>
      <div id="score" aria-live="polite" aria-atomic="true">0 : 0</div>
      <canvas id="pong" width="800" height="500" aria-label="Игровое поле Пинпонг"></canvas>

      <div id="nickname-overlay" role="dialog" aria-modal="true" aria-labelledby="nickname-label" style="display:flex;">
        <input type="text" id="nickname-input" placeholder="Введите ваш ник" maxlength="15" aria-describedby="nickname-desc" />
        <div id="nickname-label" style="position:absolute; left:-9999px;">Введите ник игрока</div>
        <div id="nickname-desc" style="position:absolute; left:-9999px;">Введите ник для рейтинга</div>
        <button id="start-btn" type="button">Начать игру</button>
      </div>
    </div>

    <div id="rating" aria-label="Рейтинг игроков">
      <h2>Рейтинг игроков</h2>
      <table>
        <thead>
          <tr><th>Место</th><th>Ник</th><th>Победы</th></tr>
        </thead>
        <tbody id="rating-body">
          <!-- Рейтинг -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Сапёр -->
  <div id="minesweeper-container" class="game-wrapper" role="main" aria-label="Игра Сапёр">
    <div id="ms-header">
      <div id="ms-status" aria-live="polite" aria-atomic="true">Мин: 10</div>
      <button id="ms-reset-btn" type="button">Новая игра</button>
      <button id="ms-back-btn" type="button">Меню</button>
    </div>
    <div id="ms-board" role="grid" aria-label="Игровое поле Сапёр"></div>
  </div>

  <!-- Гонки -->
  <div id="racing-container" class="game-wrapper" role="main" aria-label="Игра Гонки">
    <canvas id="racing-canvas" width="400" height="600" aria-label="Игровое поле Гонки"></canvas>
    <div id="racing-info" aria-live="polite" aria-atomic="true">Пройдено: 0 м (0.00 км)</div>
    <button id="racing-back-btn" type="button">Меню</button>
  </div>

  <script>
    // --- ПАЛИТРЫ ---
    const palettes = {
      default: {
        '--bg-color': '#000000',
        '--text-color': '#ffffff',
        '--btn-bg': '#0a84ff',
        '--btn-bg-hover': '#0066cc',
        '--game-bg': '#222222',
        '--paddle-color': '#ffffff',
        '--ball-color': '#ffffff',
        '--net-color': '#ffffff',
        '--rating-bg': '#111111',
        '--rating-border': '#ffffff',
        '--ms-cell-bg': '#555555',
        '--ms-cell-revealed-bg': '#bbbbbb',
        '--ms-cell-flag-color': '#f00',
        '--ms-cell-text-color': 'black'
      },
      sunset: {
        '--bg-color': '#2c1a1a',
        '--text-color': '#ffd6ba',
        '--btn-bg': '#ff6f61',
        '--btn-bg-hover': '#e65b50',
        '--game-bg': '#3e2f2f',
        '--paddle-color': '#ffb997',
        '--ball-color': '#ff6f61',
        '--net-color': '#ffb997',
        '--rating-bg': '#4a3a3a',
        '--rating-border': '#ffb997',
        '--ms-cell-bg': '#7a4e4e',
        '--ms-cell-revealed-bg': '#ffd6ba',
        '--ms-cell-flag-color': '#ff6f61',
        '--ms-cell-text-color': '#4a2c2c'
      },
      ocean: {
        '--bg-color': '#001f3f',
        '--text-color': '#a7c7e7',
        '--btn-bg': '#0074d9',
        '--btn-bg-hover': '#005fa3',
        '--game-bg': '#003366',
        '--paddle-color': '#7fdbff',
        '--ball-color': '#39cccc',
        '--net-color': '#7fdbff',
        '--rating-bg': '#00264d',
        '--rating-border': '#7fdbff',
        '--ms-cell-bg': '#005580',
        '--ms-cell-revealed-bg': '#a7c7e7',
        '--ms-cell-flag-color': '#39cccc',
        '--ms-cell-text-color': '#00334d'
      },
      forest: {
        '--bg-color': '#0b3d0b',
        '--text-color': '#c6f6c6',
        '--btn-bg': '#2ecc40',
        '--btn-bg-hover': '#27ae34',
        '--game-bg': '#145214',
        '--paddle-color': '#a3d9a5',
        '--ball-color': '#2ecc40',
        '--net-color': '#a3d9a5',
        '--rating-bg': '#1e5a1e',
        '--rating-border': '#a3d9a5',
        '--ms-cell-bg': '#2a6f2a',
        '--ms-cell-revealed-bg': '#c6f6c6',
        '--ms-cell-flag-color': '#27ae34',
        '--ms-cell-text-color': '#144214'
      },
      neon: {
        '--bg-color': '#0f0f0f',
        '--text-color': '#39ff14',
        '--btn-bg': '#39ff14',
        '--btn-bg-hover': '#2ecc40',
        '--game-bg': '#121212',
        '--paddle-color': '#39ff14',
        '--ball-color': '#ff00ff',
        '--net-color': '#39ff14',
        '--rating-bg': '#1a1a1a',
        '--rating-border': '#39ff14',
        '--ms-cell-bg': '#222222',
        '--ms-cell-revealed-bg': '#39ff14',
        '--ms-cell-flag-color': '#ff00ff',
        '--ms-cell-text-color': '#121212'
      }
    };

    function applyPalette(name) {
      const palette = palettes[name] || palettes.default;
      for (const varName in palette) {
        document.documentElement.style.setProperty(varName, palette[varName]);
      }
    }

    const paletteSelect = document.getElementById('palette-select');
    function savePalette(name) {
      localStorage.setItem('selectedPalette', name);
    }
    function loadPalette() {
      const saved = localStorage.getItem('selectedPalette');
      if (saved && (saved === 'random' || palettes[saved])) {
        return saved;
      }
      return 'random';
    }

    function getRandomPalette(exclude = ['random']) {
      const keys = Object.keys(palettes).filter(k => !exclude.includes(k));
      return keys[Math.floor(Math.random() * keys.length)];
    }

    function applySelectedPalette(name) {
      if (name === 'random') {
        const randomPal = getRandomPalette();
        applyPalette(randomPal);
        return randomPal;
      } else {
        applyPalette(name);
        return name;
      }
    }

    let currentPalette = loadPalette();
    paletteSelect.value = currentPalette;
    if (currentPalette === 'random') {
      currentPalette = applySelectedPalette('random');
    } else {
      applyPalette(currentPalette);
    }

    paletteSelect.addEventListener('change', () => {
      const val = paletteSelect.value;
      if (val === 'random') {
        currentPalette = applySelectedPalette('random');
      } else {
        currentPalette = val;
        applyPalette(val);
      }
      savePalette(val);
    });

    // --- МЕНЮ ---
    const menu = document.getElementById('menu');
    const btnPong = document.getElementById('btn-pong');
    const btnMinesweeper = document.getElementById('btn-minesweeper');
    const btnRacing = document.getElementById('btn-racing');

    const pongContainer = document.getElementById('pong-container');
    const minesweeperContainer = document.getElementById('minesweeper-container');
    const racingContainer = document.getElementById('racing-container');

    function showMenu() {
      menu.style.display = 'flex';
      pongContainer.style.display = 'none';
      minesweeperContainer.style.display = 'none';
      racingContainer.style.display = 'none';
      racingGame.stop();
    }

    btnPong.onclick = () => {
      menu.style.display = 'none';
      minesweeperContainer.style.display = 'none';
      racingContainer.style.display = 'none';
      pongContainer.style.display = 'flex';
    };
    btnMinesweeper.onclick = () => {
      menu.style.display = 'none';
      pongContainer.style.display = 'none';
      racingContainer.style.display = 'none';
      minesweeperContainer.style.display = 'flex';
      minesweeperGame.init();
    };
    btnRacing.onclick = () => {
      menu.style.display = 'none';
      pongContainer.style.display = 'none';
      minesweeperContainer.style.display = 'none';
      racingContainer.style.display = 'flex';
      racingGame.start();
    };

    // --- ПИНПОНГ --- (код как в предыдущем ответе, не повторяю для краткости)
    // ... (оставьте код пинпонга из предыдущего ответа)

    // --- САПЁР --- (код как в предыдущем ответе, не повторяю для краткости)
    // ... (оставьте код сапёра из предыдущего ответа)

    // --- ГОНКИ ---
    const racingGame = (function(){
      const canvas = document.getElementById('racing-canvas');
      const ctx = canvas.getContext('2d');
      const info = document.getElementById('racing-info');
      const backBtn = document.getElementById('racing-back-btn');

      const width = canvas.width;
      const height = canvas.height;

      // Полосы: 4 полосы, 2 в одну сторону, 2 в другую
      // Игрок может быть в одной из 4 полос (0..3)
      // Полосы 0 и 1 идут сверху вниз (машины движутся вниз)
      // Полосы 2 и 3 идут снизу вверх (машины движутся вверх)

      const laneCount = 4;
      const laneWidth = width / laneCount;

      // Игрок
      const player = {
        lane: 1, // стартовая полоса (1 или 2 для удобства)
        width: laneWidth * 0.7,
        height: 60,
        color: '#00ff00',
        y: height - 80,
      };

      // Другие машины
      const carWidth = laneWidth * 0.7;
      const carHeight = 50;

      // Скорость движения трассы и машин (пикселей в кадр)
      let speed = 4;

      // Машины на полосах
      // Для полос 0 и 1 машины движутся вниз (y увеличивается)
      // Для полос 2 и 3 машины движутся вверх (y уменьшается)
      // Машины хранятся в массивах по полосам
      let cars = [[], [], [], []];

      // Таймер для генерации машин
      let spawnTimer = 0;
      const spawnInterval = 60; // кадров между спавном

      // Время игры (кадры)
      let frames = 0;
      let running = false;

      // Управление
      let leftPressed = false;
      let rightPressed = false;

      // Звуки и эффекты можно добавить позже

      function drawRoad() {
        ctx.fillStyle = '#222';
        ctx.fillRect(0, 0, width, height);

        // Разметка полос
        ctx.strokeStyle = '#888';
        ctx.lineWidth = 2;
        for(let i=1; i<laneCount; i++) {
          const x = i * laneWidth;
          ctx.setLineDash([20, 20]);
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, height);
          ctx.stroke();
        }
        ctx.setLineDash([]);
      }

      function drawCar(x, y, width, height, color) {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.moveTo(x + width*0.5, y);
        ctx.lineTo(x + width*0.9, y + height*0.3);
        ctx.lineTo(x + width*0.9, y + height*0.7);
        ctx.lineTo(x + width*0.5, y + height);
        ctx.lineTo(x + width*0.1, y + height*0.7);
        ctx.lineTo(x + width*0.1, y + height*0.3);
        ctx.closePath();
        ctx.fill();

        // Фары
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.arc(x + width*0.3, y + height*0.15, 5, 0, Math.PI*2);
        ctx.arc(x + width*0.7, y + height*0.15, 5, 0, Math.PI*2);
        ctx.fill();
      }

      function spawnCar(lane) {
        // Создаём машину в полосе lane
        // Для полос 0,1 y = -carHeight (сверху)
        // Для полос 2,3 y = height (снизу)
        const direction = lane < 2 ? 1 : -1;
        const y = direction === 1 ? -carHeight : height;
        const x = lane * laneWidth + (laneWidth - carWidth)/2;
        const color = getRandomColor();
        cars[lane].push({x, y, width: carWidth, height: carHeight, color, direction});
      }

      function getRandomColor() {
        // Возьмём цвет из текущей палитры для машин (например, paddle-color или ball-color)
        // Или случайный яркий цвет
        const colors = ['#e74c3c','#3498db','#f1c40f','#9b59b6','#e67e22','#1abc9c','#2ecc71'];
        return colors[Math.floor(Math.random()*colors.length)];
      }

      function updateCars() {
        for(let lane=0; lane<laneCount; lane++) {
          const direction = lane < 2 ? 1 : -1;
          for(let i = cars[lane].length - 1; i >= 0; i--) {
            const car = cars[lane][i];
            car.y += speed * direction;
            // Удаляем машины, вышедшие за экран
            if ((direction === 1 && car.y > height) || (direction === -1 && car.y + car.height < 0)) {
              cars[lane].splice(i, 1);
            }
          }
        }
      }

      function drawCars() {
        for(let lane=0; lane<laneCount; lane++) {
          for(const car of cars[lane]) {
            drawCar(car.x, car.y, car.width, car.height, car.color);
          }
        }
      }

      function drawPlayer() {
        const x = player.lane * laneWidth + (laneWidth - player.width)/2;
        drawCar(x, player.y, player.width, player.height, player.color);
      }

      function checkCollision() {
        const px = player.lane * laneWidth + (laneWidth - player.width)/2;
        const py = player.y;
        const pw = player.width;
        const ph = player.height;

        for(let lane=0; lane<laneCount; lane++) {
          for(const car of cars[lane]) {
            if (lane !== player.lane) continue;
            // Проверка пересечения прямоугольников
            if (px < car.x + car.width &&
                px + pw > car.x &&
                py < car.y + car.height &&
                py + ph > car.y) {
              return true;
            }
          }
        }
        return false;
      }

      function update() {
        if (!running) return;

        frames++;
        spawnTimer++;

        // Управление игроком
        if (leftPressed && player.lane > 0) {
          player.lane--;
          leftPressed = false;
        }
        if (rightPressed && player.lane < laneCount - 1) {
          player.lane++;
          rightPressed = false;
        }

        // Спавн машин
        if (spawnTimer >= spawnInterval) {
          spawnTimer = 0;
          // Спавним машину в случайной полосе, кроме полосы игрока (чтобы не было слишком сложно)
          let laneToSpawn;
          do {
            laneToSpawn = Math.floor(Math.random() * laneCount);
          } while (laneToSpawn === player.lane);
          spawnCar(laneToSpawn);
        }

        updateCars();

        if (checkCollision()) {
          stop();
          alert(`Вы столкнулись! Пройдено: ${getDistance()} м (${(getDistance()/1000).toFixed(2)} км)`);
          showMenu();
        }
      }

      function draw() {
        ctx.clearRect(0, 0, width, height);
        drawRoad();
        drawCars();
        drawPlayer();
      }

      function gameLoop() {
        if (!running) return;
        update();
        draw();
        updateInfo();
        requestAnimationFrame(gameLoop);
      }

      function updateInfo() {
        const dist = getDistance();
        info.textContent = `Пройдено: ${dist} м (${(dist/1000).toFixed(2)} км)`;
      }

      function getDistance() {
        // Пройденное расстояние пропорционально времени (frames) и скорости
        // Пусть 1 кадр = 1/60 секунды, скорость = 4 пикселя/кадр
        // Пусть 1 пиксель = 1 метр (условно)
        return Math.floor(frames * speed);
      }

      function start() {
        if (running) return;
        running = true;
        frames = 0;
        spawnTimer = 0;
        player.lane = 1;
        cars = [[], [], [], []];
        updateInfo();
        gameLoop();
      }

      function stop() {
        running = false;
      }

      // Управление клавишами
      function onKeyDown(e) {
        if (!running) return;
        if (e.key === 'ArrowLeft' || e.key === 'a') {
          leftPressed = true;
          e.preventDefault();
        }
        if (e.key === 'ArrowRight' || e.key === 'd') {
          rightPressed = true;
          e.preventDefault();
        }
      }
      function onKeyUp(e) {
        if (!running) return;
        if (e.key === 'ArrowLeft' || e.key === 'a') {
          leftPressed = false;
          e.preventDefault();
        }
        if (e.key === 'ArrowRight' || e.key === 'd') {
          rightPressed = false;
          e.preventDefault();
        }
      }

      // Обработчик кнопки выхода
      backBtn.onclick = () => {
        stop();
        showMenu();
      };

      // Добавляем слушатели клавиатуры при старте и убираем при остановке
      function addListeners() {
        window.addEventListener('keydown', onKeyDown);
        window.addEventListener('keyup', onKeyUp);
      }
      function removeListeners() {
        window.removeEventListener('keydown', onKeyDown);
        window.removeEventListener('keyup', onKeyUp);
      }

      // Обновляем слушатели при старте/стопе
      function startGame() {
        start();
        addListeners();
      }
      function stopGame() {
        stop();
        removeListeners();
      }

      return {
        start: startGame,
        stop: stopGame
      };
    })();

    // --- ПИНПОНГ и САПЁР код из предыдущих ответов ---
    // Для краткости не повторяю здесь, вставьте их из предыдущего ответа.

  </script>
</body>
</html>
