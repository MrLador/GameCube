<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Monument Valley Style Puzzle</title>
<style>
  /* Сброс и базовые стили */
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(135deg, #e0f2f1, #b2dfdb);
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    user-select: none;
    overflow: hidden;
  }

  #game-container {
    width: 90vmin;
    height: 90vmin;
    max-width: 600px;
    max-height: 600px;
    background: #ffffffcc;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    position: relative;
  }

  svg {
    width: 100%;
    height: 100%;
    display: block;
  }

  /* Плавные переходы для трансформаций */
  .tile, .player, .goal {
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Плитки */
  .tile {
    cursor: pointer;
    stroke: #607d8b;
    stroke-width: 1.5;
  }

  /* Персонаж */
  .player {
    fill: #ff8a65;
    filter: drop-shadow(0 0 2px #ff7043);
  }

  /* Цель */
  .goal {
    fill: url(#goalGradient);
    stroke: #4db6ac;
    stroke-width: 2;
  }

  /* Подсветка активной плитки */
  .tile.active {
    stroke: #ff7043;
    stroke-width: 3;
  }

  /* Инструкция */
  #instructions {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.85rem;
    color: #455a64;
    user-select: none;
  }
</style>
</head>
<body>
<div id="game-container" tabindex="0" aria-label="Puzzle game in Monument Valley style">
  <svg viewBox="0 0 600 600" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
    <defs>
      <!-- Градиенты для плиток -->
      <linearGradient id="tileGradient" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#a7c7e7" />
        <stop offset="100%" stop-color="#d0e6f7" />
      </linearGradient>
      <linearGradient id="goalGradient" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#80cbc4" />
        <stop offset="100%" stop-color="#4db6ac" />
      </linearGradient>
      <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.15"/>
      </filter>
    </defs>

    <!-- Группа уровня, которую будем поворачивать -->
    <g id="level-group" transform="translate(300,300)">
      <!-- Плитки будут добавлены динамически -->
    </g>

    <!-- Персонаж -->
    <circle id="player" class="player" r="15" cx="0" cy="0" filter="url(#shadow)" />

    <!-- Цель -->
    <rect id="goal" class="goal" width="40" height="40" rx="6" ry="6" filter="url(#shadow)" />
  </svg>

  <div id="instructions">
    Используйте стрелки для перемещения, пробел — поворот уровня
  </div>
</div>

<script>
  /*
   * Игра в стиле Monument Valley с изометрической проекцией
   * Автор: Heck.ai
   */

  (function() {
    const svgNS = "http://www.w3.org/2000/svg";

    // Параметры изометрии
    // Изометрическая проекция: x' = (x - y) * cos(30°), y' = (x + y) * sin(30°)
    const isoAngle = Math.PI / 6; // 30 градусов
    const tileSize = 60; // размер плитки в "логических" единицах

    // Игровое поле (логическая сетка)
    // 0 - пусто, 1 - плитка
    // Пример уровня 5x5 с "островками"
    const levelMap = [
      [0, 0, 1, 0, 0],
      [0, 1, 1, 1, 0],
      [1, 1, 1, 1, 1],
      [0, 1, 1, 1, 0],
      [0, 0, 1, 0, 0],
    ];

    const rows = levelMap.length;
    const cols = levelMap[0].length;

    // Игрок и цель в логических координатах
    let playerPos = {x: 2, y: 4}; // старт внизу по центру
    const goalPos = {x: 2, y: 0}; // цель сверху по центру

    // Текущий угол поворота уровня (0, 90, 180, 270)
    let rotation = 0;

    // Ссылки на SVG элементы
    const levelGroup = document.getElementById('level-group');
    const playerElem = document.getElementById('player');
    const goalElem = document.getElementById('goal');
    const container = document.getElementById('game-container');

    // Преобразование логических координат в изометрические SVG координаты
    function isoProject(x, y) {
      // Сначала применим поворот уровня к координатам
      let rx, ry;
      switch(rotation) {
        case 0: rx = x; ry = y; break;
        case 90: rx = y; ry = cols - 1 - x; break;
        case 180: rx = cols - 1 - x; ry = rows - 1 - y; break;
        case 270: rx = rows - 1 - y; ry = x; break;
      }
      // Изометрическая проекция
      const isoX = (rx - ry) * Math.cos(isoAngle) * tileSize;
      const isoY = (rx + ry) * Math.sin(isoAngle) * tileSize;
      return {x: isoX, y: isoY};
    }

    // Создаем плитку SVG элемента
    function createTile(x, y) {
      // Изометрический шестиугольник (параллелограмм)
      // Для простоты — ромб из 4 точек
      const points = [
        {x: 0, y: -tileSize / 2},
        {x: tileSize * Math.cos(isoAngle), y: 0},
        {x: 0, y: tileSize / 2},
        {x: -tileSize * Math.cos(isoAngle), y: 0},
      ];

      const polygon = document.createElementNS(svgNS, 'polygon');
      polygon.setAttribute('class', 'tile');
      polygon.setAttribute('fill', 'url(#tileGradient)');
      polygon.setAttribute('points', points.map(p => `${p.x},${p.y}`).join(' '));
      polygon.setAttribute('data-x', x);
      polygon.setAttribute('data-y', y);

      // Позиционируем плитку
      const pos = isoProject(x, y);
      polygon.setAttribute('transform', `translate(${pos.x},${pos.y})`);

      return polygon;
    }

    // Отрисовка уровня
    function drawLevel() {
      levelGroup.innerHTML = '';
      for(let y=0; y<rows; y++) {
        for(let x=0; x<cols; x++) {
          if(levelMap[y][x] === 1) {
            const tile = createTile(x, y);
            levelGroup.appendChild(tile);
          }
        }
      }
    }

    // Обновление позиции игрока
    function updatePlayer() {
      const pos = isoProject(playerPos.x, playerPos.y);
      playerElem.setAttribute('cx', pos.x);
      playerElem.setAttribute('cy', pos.y);
    }

    // Обновление позиции цели
    function updateGoal() {
      const pos = isoProject(goalPos.x, goalPos.y);
      goalElem.setAttribute('x', pos.x - 20);
      goalElem.setAttribute('y', pos.y - 20);
    }

    // Проверка, есть ли плитка в координатах
    function isTile(x, y) {
      if(x < 0 || y < 0 || y >= rows || x >= cols) return false;
      return levelMap[y][x] === 1;
    }

    // Проверка победы
    function checkWin() {
      if(playerPos.x === goalPos.x && playerPos.y === goalPos.y) {
        setTimeout(() => alert('Поздравляем! Вы достигли цели!'), 100);
      }
    }

    // Перемещение игрока, если возможно
    function movePlayer(dx, dy) {
      const nx = playerPos.x + dx;
      const ny = playerPos.y + dy;
      if(isTile(nx, ny)) {
        playerPos.x = nx;
        playerPos.y = ny;
        updatePlayer();
        checkWin();
      }
    }

    // Поворот уровня на 90 градусов по часовой стрелке
    function rotateLevel() {
      rotation = (rotation + 90) % 360;
      // Плавно поворачиваем группу уровня
      levelGroup.style.transition = 'transform 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
      levelGroup.setAttribute('transform', `translate(300,300) rotate(${rotation})`);

      // После анимации обновим позицию игрока и цели (т.к. координаты логические не меняются, но визуально меняется)
      setTimeout(() => {
        updatePlayer();
        updateGoal();
      }, 500);
    }

    // Обработка нажатий клавиш
    function onKeyDown(e) {
      switch(e.key) {
        case 'ArrowUp':
          movePlayer(0, -1);
          e.preventDefault();
          break;
        case 'ArrowDown':
          movePlayer(0, 1);
          e.preventDefault();
          break;
        case 'ArrowLeft':
          movePlayer(-1, 0);
          e.preventDefault();
          break;
        case 'ArrowRight':
          movePlayer(1, 0);
          e.preventDefault();
          break;
        case ' ':
          rotateLevel();
          e.preventDefault();
          break;
      }
    }

    // Инициализация игры
    function init() {
      drawLevel();
      updatePlayer();
      updateGoal();

      // Начальный поворот
      levelGroup.setAttribute('transform', `translate(300,300) rotate(${rotation})`);

      // Фокус для клавиатуры
      container.focus();

      container.addEventListener('keydown', onKeyDown);
    }

    // Запускаем игру
    init();

  })();
</script>
</body>
</html>
